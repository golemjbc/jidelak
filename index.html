<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI J√≠deln√≠ƒçek</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: #27272a;
      border-radius: 10px;
    }
  </style>
</head>

<body class="bg-zinc-950 text-zinc-200 h-screen flex flex-col">

  <!-- HEADER -->
  <div class="p-4 border-b border-zinc-800 text-lg font-semibold tracking-wide">
    üçΩÔ∏è AI J√≠deln√≠ƒçek
  </div>

  <!-- HISTORIE -->
  <div id="historySection"
       class="h-1/3 overflow-y-auto border-b border-zinc-800 p-4 space-y-3 bg-zinc-900">
    <div class="text-sm text-zinc-400">Naƒç√≠t√°m historii...</div>
  </div>

  <!-- CHAT -->
  <div id="chatSection"
       class="flex-1 overflow-y-auto p-4 space-y-4">
  </div>

  <!-- INPUT -->
  <div class="border-t border-zinc-800 p-4 flex gap-3 bg-zinc-900">
    <input id="messageInput"
           type="text"
           placeholder="Napi≈° zpr√°vu..."
           class="flex-1 bg-zinc-800 text-zinc-200 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
    <button onclick="sendMessage()"
            class="bg-blue-600 hover:bg-blue-500 px-5 py-2 rounded-lg font-medium transition">
      Odeslat
    </button>
  </div>

<script>
/* ============================
   üîß NASTAVEN√ç
============================ */
const API_BASE = "https://TVOJE-FUNKCE.azurewebsites.net/api";

/* ============================
   üì¶ NAƒåTEN√ç DAT
============================ */
document.addEventListener("DOMContentLoaded", async () => {
  await loadHistory();
  await loadSession();
});

/* ============================
   üìú HISTORIE
============================ */
async function loadHistory() {
  try {
    const res = await fetch(`${API_BASE}/history`);
    const data = await res.json();

    const history = data.history || [];
    const last14 = filterLast14Days(history);

    renderHistory(last14);
  } catch (err) {
    document.getElementById("historySection").innerHTML =
      `<div class="text-red-500 text-sm">Chyba naƒç√≠t√°n√≠ historie</div>`;
  }
}

function filterLast14Days(history) {
  const now = new Date();
  return history.filter(item => {
    const d = new Date(item.date);
    const diff = (now - d) / (1000 * 60 * 60 * 24);
    return diff <= 14;
  }).reverse();
}

function renderHistory(items) {
  const container = document.getElementById("historySection");
  container.innerHTML = "";

  if (items.length === 0) {
    container.innerHTML =
      `<div class="text-sm text-zinc-500">≈Ω√°dn√° historie.</div>`;
    return;
  }

  let grouped = {};

  items.forEach(item => {
    if (!grouped[item.date]) grouped[item.date] = [];
    grouped[item.date].push(item);
  });

  Object.keys(grouped).sort().reverse().forEach(date => {
    const block = document.createElement("div");
    block.innerHTML = `
      <div class="text-xs text-zinc-400 mb-1">${date}</div>
      <div class="space-y-1">
        ${grouped[date].map(i =>
          `<div class="text-sm bg-zinc-800 px-3 py-1 rounded-md inline-block mr-2">
            ${i.meal_name || i.meal_id}
           </div>`
        ).join("")}
      </div>
    `;
    container.appendChild(block);
  });
}

/* ============================
   üí¨ SESSION / CHAT
============================ */
async function loadSession() {
  try {
    const res = await fetch(`${API_BASE}/session`);
    const data = await res.json();

    const today = new Date().toISOString().slice(0,10);
    const todaysSession = (data.sessions || [])
      .find(s => s.date === today);

    if (todaysSession) {
      renderChat(todaysSession.messages);
    }
  } catch (err) {
    console.error("Session error", err);
  }
}

function renderChat(messages) {
  const chat = document.getElementById("chatSection");
  chat.innerHTML = "";

  messages.forEach(msg => {
    appendMessage(msg.role, msg.content);
  });

  scrollChatToBottom();
}

function appendMessage(role, content) {
  const chat = document.getElementById("chatSection");

  const wrapper = document.createElement("div");
  wrapper.className = role === "user"
    ? "flex justify-end"
    : "flex justify-start";

  wrapper.innerHTML = `
    <div class="max-w-[75%] px-4 py-2 rounded-xl ${
      role === "user"
        ? "bg-blue-600 text-white"
        : "bg-zinc-800 text-zinc-200"
    }">
      ${content}
    </div>
  `;

  chat.appendChild(wrapper);
}

/* ============================
   üì§ ODESL√ÅN√ç ZPR√ÅVY
============================ */
async function sendMessage() {
  const input = document.getElementById("messageInput");
  const message = input.value.trim();

  if (!message) return;

  appendMessage("user", message);
  input.value = "";
  scrollChatToBottom();

  try {
    const res = await fetch(`${API_BASE}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });

    const data = await res.json();

    appendMessage("assistant", data.reply);
    scrollChatToBottom();

    // refresh historie po z√°pisu
    await loadHistory();

  } catch (err) {
    appendMessage("assistant", "Chyba komunikace s backendem.");
  }
}

/* ============================
   ‚¨áÔ∏è AUTO SCROLL
============================ */
function scrollChatToBottom() {
  const chat = document.getElementById("chatSection");
  chat.scrollTop = chat.scrollHeight;
}

/* ============================
   ‚å®Ô∏è ENTER ODESL√ÅN√ç
============================ */
document.getElementById("messageInput")
  .addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      sendMessage();
    }
  });

</script>

</body>
</html>
