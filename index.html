<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ELAI</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background: radial-gradient(circle at 20% 20%, #2e1065 0%, #000000 60%);
}

#chatSection::-webkit-scrollbar,
#historySection::-webkit-scrollbar {
  width: 6px;
}
#chatSection::-webkit-scrollbar-thumb,
#historySection::-webkit-scrollbar-thumb {
  background: #7c3aed;
  border-radius: 10px;
}

.glow {
  text-shadow: 0 0 12px rgba(139,92,246,0.8);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body class="h-screen flex flex-col text-zinc-200">

<!-- LOGO -->
<div class="flex justify-center py-4">
  <img src="img/ELAI.png"
       class="w-full max-w-2xl object-contain glow" />
</div>

<!-- HISTORIE -->
<div id="historySection"
     class="h-56 overflow-y-auto px-6 py-4 backdrop-blur-xl bg-white/5 border-y border-white/10 flex flex-col">
</div>

<!-- CHAT -->
<div id="chatSection"
     class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
</div>

<!-- INPUT -->
<div class="p-4 backdrop-blur-xl bg-white/5 border-t border-white/10 flex gap-3">
  <input id="messageInput"
         type="text"
         placeholder="Tak co mi dneska naservÃ­rujeÅ¡?"
         class="flex-1 bg-black/40 border border-violet-600/40 text-zinc-200 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-violet-500" />
  <button onclick="sendMessage()"
          class="bg-gradient-to-r from-violet-600 to-purple-500 px-6 py-2 rounded-xl font-medium hover:scale-105 transition">
    Odeslat
  </button>
</div>

<script>

const API_BASE = "https://jidelak-bng5gggscsevacbw.westeurope-01.azurewebsites.net/api";

/* ================================
   ðŸ”¥ VÅ ECHNY PÅ®VODNÃ HLÃÅ KY
================================ */
const loadingMessages = [
"ZvyÅ¡uju tlak. UdrÅ¾Ã­Å¡ to?",
"Teplota roste. A jÃ¡ to miluju.",
"JeÅ¡tÄ› chvÃ­liâ€¦ a praskne to.",
"DusÃ­m tÄ› napÄ›tÃ­m.",
"DrÅ¾ se. Bude to intenzivnÃ­.",
"Tlak stoupÃ¡. VÃ½sledek bude vÃ½buÅ¡nÃ½.",
"VaÅ™Ã­m to tak dlouho, aÅ¾ to pÅ™eteÄe.",
"MÃ­chÃ¡m to tvrdÄ›. A bez slitovÃ¡nÃ­.",
"CÃ­tÃ­Å¡ to napÄ›tÃ­?",
"JeÅ¡tÄ› pÃ¡r vteÅ™inâ€¦ a exploduje to.",
"ZahÅ™Ã­vÃ¡m to na hranici Ãºnosnosti.",
"Trochu vlhka nikdy neuÅ¡kodÃ­.",
"PÅ™iprav se. Bude to silnÃ©.",
"NapÃ­nÃ¡m tÄ› schvÃ¡lnÄ›.",
"Hraju si s tlakem, dokud to nevystÅ™elÃ­.",
"DusÃ­m tÄ› pomalu. ProtoÅ¾e mÅ¯Å¾u.",
"JeÅ¡tÄ› vÃ­c teplaâ€¦ jeÅ¡tÄ› vÃ­c napÄ›tÃ­.",
"BlÃ­Å¾Ã­m se k vrcholu vÃ½poÄtu.",
"Tohle bude mÃ­t nÃ¡boj.",
"ChceÅ¡ to rychle? SmÅ¯la."
];

let loadingBubble = null;
let loadingInterval = null;

/* ====================================
   INIT
==================================== */
document.addEventListener("DOMContentLoaded", async () => {
  await loadHistory();
  await loadSession();
});

/* ====================================
   HISTORIE â€“ 14 DNÃ + POSLEDNÃ 4 VIDITELNÃ‰
==================================== */
async function loadHistory() {
  try {
    const res = await fetch(`${API_BASE}/history`);
    const data = await res.json();
    const history = data.history || [];
    const last14 = filterLast14Days(history);
    renderHistory(last14);
  } catch {}
}

function filterLast14Days(history) {
  const now = new Date();
  return history.filter(item => {
    const d = new Date(item.date);
    const diff = (now - d) / (1000 * 60 * 60 * 24);
    return diff <= 14;
  });
}

function renderHistory(items) {
  const container = document.getElementById("historySection");
  container.innerHTML = "";

  if (!items.length) return;

  // seÅ™adÃ­me chronologicky
  items.sort((a, b) => new Date(a.date) - new Date(b.date));

  items.forEach(item => {
    const row = document.createElement("div");
    row.className =
      "mb-2 px-4 py-2 rounded-xl bg-black/40 border border-violet-500/30 backdrop-blur-md text-sm animate-[fadeIn_0.3s_ease]";
    row.innerHTML = `
      <span class="text-zinc-400">${item.date}</span>
      <span class="ml-3 text-violet-300">
        ${item.meal_name || item.meal_id}
      </span>
    `;
    container.appendChild(row);
  });

  // scroll dolÅ¯ â†’ poslednÃ­ 4 vÅ¾dy viditelnÃ©
  container.scrollTop = container.scrollHeight;
}

/* ====================================
   SESSION
==================================== */
async function loadSession() {
  try {
    const res = await fetch(`${API_BASE}/session`);
    const data = await res.json();
    const today = new Date().toISOString().slice(0,10);
    const todaysSession = (data.sessions || []).find(s => s.date === today);
    if (todaysSession) renderChat(todaysSession.messages);
  } catch {}
}

function renderChat(messages) {
  const chat = document.getElementById("chatSection");
  chat.innerHTML = "";
  messages.forEach(msg => appendMessage(msg.role, msg.content));
  scrollChatToBottom();
}

function appendMessage(role, content) {
  const chat = document.getElementById("chatSection");
  const wrapper = document.createElement("div");
  wrapper.className = role === "user"
    ? "flex justify-end"
    : "flex justify-start";

  wrapper.innerHTML = `
    <div class="max-w-[70%] px-5 py-3 rounded-2xl ${
      role === "user"
        ? "bg-gradient-to-br from-violet-600 to-purple-500 text-white"
        : "bg-black/40 backdrop-blur-xl border border-violet-500/30 text-zinc-200"
    } animate-[fadeIn_0.3s_ease] shadow-lg">
      ${content}
    </div>`;

  chat.appendChild(wrapper);
}

/* ====================================
   LOADING â€“ MÄšNÃ SE PO 2s
==================================== */
function showLoading() {
  const chat = document.getElementById("chatSection");

  loadingBubble = document.createElement("div");
  loadingBubble.className = "flex justify-start";

  const bubbleInner = document.createElement("div");
  bubbleInner.className =
    "bg-black/40 border border-violet-500/40 text-violet-300 px-5 py-3 rounded-2xl italic";

  bubbleInner.innerText =
    loadingMessages[Math.floor(Math.random() * loadingMessages.length)];

  loadingBubble.appendChild(bubbleInner);
  chat.appendChild(loadingBubble);
  scrollChatToBottom();

  loadingInterval = setInterval(() => {
    bubbleInner.innerText =
      loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
  }, 2000);
}

function hideLoading() {
  if (loadingInterval) clearInterval(loadingInterval);
  if (loadingBubble) loadingBubble.remove();
  loadingBubble = null;
}

/* ====================================
   SEND
==================================== */
async function sendMessage() {
  const input = document.getElementById("messageInput");
  const message = input.value.trim();
  if (!message) return;

  appendMessage("user", message);
  input.value = "";
  scrollChatToBottom();

  showLoading();

  try {
    const res = await fetch(`${API_BASE}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });

    const data = await res.json();
    hideLoading();
    appendMessage("assistant", data.reply);
    scrollChatToBottom();
    await loadHistory();
  } catch {
    hideLoading();
  }
}

function scrollChatToBottom() {
  const chat = document.getElementById("chatSection");
  chat.scrollTop = chat.scrollHeight;
}

document.getElementById("messageInput")
  .addEventListener("keypress", function(e) {
    if (e.key === "Enter") sendMessage();
  });

</script>
</body>
</html>
